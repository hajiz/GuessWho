<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My fb app here</title>

<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css" media="screen" />

<style>
.bordered
{
	border: 1px solid grey;
	padding: 20px;
	border-radius: 10px;
}

.post
{
	background-color: #3344AA;
	border-radius: 10px;
	margin-top: 10px;
	margin-bottom: 10px;
	padding: 50px;
}

a, a:hover
{
	color: white;
	font-weight: bold;
	font-size: 1.2em;
}
</style>
</head>
<body>
<script src="js/Utility.js"></script>
<script src="js/FB.js"></script>
<script src="config.js"></script>
<script src="http://code.jquery.com/jquery.js"></script>

<script src="bootstrap/js/bootstrap.js"></script>
<div id="fb-root"></div>
<script>
log("using app ID : " + hiddenConfig.appId);
window.fbAsyncInit = function() {
	FB.init({
		appId : hiddenConfig.appId,
		status : true
	});
	// Additional initialization code such as adding Event Listeners goes here
	
	login();
};

(function(d, s, id) {
	var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) {
		return;
	}
	js = d.createElement(s);
	js.id = id;
	js.src = "//connect.facebook.net/en_US/all.js";
	fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

function loadFriends() {
	var me = new Person('me');
	var friends = me.getFriends();
	var list = $("#list");
	friends.then = function (data) {
		$("#load").hide();
		$("#start").removeAttr("disabled");
		window.friends = friends;
		next();
		var names = [];
		for (var i = 0; i < friends.data.length; i++)
			names.push(friends.data[i].name);
		$("#guess").typeahead({ source: names });
	};
}

function next() {
	var friends = window.friends;
	var count = friends.data.length;
	var rand = parseInt(Math.random() * count);
	window.friend = friends.get(rand);
}

function retrieve(id) {
	var friend = new Person(id);
	var posts = friend.getStatuses();
	var links = friend.getLinks();
	var statusTemplate = "<a href='http://facebook.com/{id}'><div class='post'>{message}</div></a>";
	var linkTemplate = "<a href='http://facebook.com/{id}'><div class='post'>{message}<br><a href='{link}'>{link}</a></div></a>";
	var list = $("#list");
	list.html("");
	posts.then = function (data) {
		for (key in data) {
			if (Math.random() < 0.1)
				list.append(statusTemplate
						.replace(/{message}/g,data[key].message)
						.replace(/{id}/g,data[key].id)
						);
		}
	};
	links.then = function (data) {
		for (key in data) {
			if (data[key].link[0] === '/')
				data[key].link = "http://www.facebook.com" + data[key].link;
			if (typeof data[key].name === "undefined")
				data[key].name = "";
			if (typeof data[key].message === "undefined")
				data[key].message = "";
			if (Math.random() < 0.1)
				list.append(linkTemplate
						.replace(/{message}/g,data[key].message)
						.replace(/{id}/g,data[key].id)
						.replace(/{link}/g,data[key].link)
						.replace(/{name}/g,data[key].name)
						);
		}
	};
}

function start() {
	log("showing : " + window.friend.name);
	$("#start").hide();
	$("#next").removeAttr("disabled");
	$("#guessbtn").removeAttr("disabled");
	retrieve(window.friend.id);
}

function guess() {
	var guess = $("#guess");
	var status = $("#status");
	if (guess.val() === window.friend.name) {
		status.html("Yaaaaaaaay!! Now next...");
		next();
		start();
	} else {
		status.html("Not quite right... try again!");
	}
	guess.val("");
}

function login() {
	FB.login(function(response) {
		if (response.authResponse) {
			log('Welcome!  Fetching your information.... ');
			FB.api('/me', function(response) {
				log('Good to see you, ' + response.name + '.');
			});
			loadFriends();
		} else {
			log('User cancelled login or did not fully authorize.');
		}
	});
}
</script>
<div class="container bordered">
	<form>
		<input id="guess" class="input-large" placeholder="Guess Who?"></input>
	</form>
	<button class="btn btn-primary btn-medium" id="start" onclick="start();" disabled>Start the game</button>
	<button class="btn btn-primary btn-medium" id="guessbtn" onclick="guess();" disabled>Check</button>
	<button class="btn btn-primary btn-medium" id="next" onclick="next();start();" disabled>Next</button>
	<span id="load">Please wait...</span><span id="status"></span><br/>
	<div id="list" class="span9"></div>
</div>
</body>
</html>
